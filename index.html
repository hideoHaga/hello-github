<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>p5.js Live Editor (Final)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- p5.js -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
  <!-- CodeMirror v5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/javascript/javascript.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/closebrackets.js"></script>

  <style>
    :root {
      --leftWidth: 50vw;           /* 左ペイン幅（ドラッグで更新） */
      --topRatioGlobals: 0.22;     /* 右最上段（グローバル定義）の高さ比 */
      --topRatioEditors: 0.5;      /* 右下段の中の setup:draw 比 */
    }
    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      background: #f7f7f7;
      color: #222;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .app {
      position: relative;          /* 左右ドラッグの座標基準 */
      display: flex;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* 左＝キャンバス */
    .left {
      width: var(--leftWidth);
      min-width: 240px;
      background: #fff;
      border-right: 2px solid #ddd;
      display: flex;
      align-items: stretch;
      justify-content: center;
      min-height: 0; min-width: 0;
    }
    #canvas-wrap { position: relative; flex: 1; min-height: 0; min-width: 0; }
    canvas { display: block; }

    /* 仕切り（左右） */
    .resizer-x { width: 6px; cursor: col-resize; background: #eee; }

    /* 右＝エディタ群 */
    .right {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      background: #fafafa;
      min-height: 0; min-width: 0;
    }
    .pane-title {
      padding: 8px 12px;
      font-size: 13px;
      color: #555;
      background:#f0f0f0;
      border-bottom:1px solid #ddd;
    }

    .right-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; min-width: 0; }

    /* 上段＝グローバル定義 */
    .globals-pane {
      flex: 0 0 calc(var(--topRatioGlobals) * 100%);
      min-height: 90px;
      display: flex; flex-direction: column;
      padding: 8px; gap: 6px;
      min-width: 0;
    }
    .row-resizer-G {
      height: 6px; background: #eee; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; cursor: row-resize;
    }

    /* 下段＝setup/draw スタック */
    .editors { flex: 1; display: flex; flex-direction: column; padding: 8px; gap: 6px; overflow: hidden; min-height: 0; min-width: 0; }
    .stack { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; min-width: 0; }
    .top-pane { flex: 0 0 calc(var(--topRatioEditors) * 100% - 3px); min-height: 80px; display: flex; flex-direction: column; min-width: 0; }
    .row-resizer { height: 6px; background: #eee; border: 1px solid #ddd; border-left: 0; border-right: 0; cursor: row-resize; }
    .bottom-pane { flex: 1 1 auto; min-height: 80px; display: flex; flex-direction: column; min-width: 0; }

    /* エディタブロック */
    .editor { flex: 1; display: flex; flex-direction: column; background:#fff; border:1px solid #ccc; border-radius: 8px; overflow: hidden; min-height: 0; min-width: 0; }
    .editor header { font-size: 12px; padding: 6px 8px; color:#0366d6; background:#f8f8f8; border-bottom:1px solid #ddd; }

    /* CodeMirror：スクロールは正規の要素にだけ適用 */
    .cm-host { flex: 1; min-height: 0; min-width: 0; }
    .CodeMirror {
      height: 100%;
      width: 100%;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      line-height: 1.5;
      overflow: hidden;     /* 本体は hidden */
    }
    .CodeMirror-scroll { overflow: auto; }  /* 必要時のみ縦横バー表示 */

    .statusbar { padding: 6px 12px; border-top:1px solid #ddd; font-size:12px; color:#555; background:#f9f9f9; }
    .errors { padding: 6px 12px; color:#b00020; font-size:12px; white-space: pre-wrap; }

    /* ドラッグ中の選択暴発防止＆カーソル統一 */
    body.dragging, body.dragging * { user-select: none !important; }
  </style>
</head>
<body>
  <div class="app">
    <div class="left" id="left"><div id="canvas-wrap"></div></div>
    <div class="resizer-x" id="resizerX" title="ドラッグで幅を調整"></div>

    <div class="right">
      <div class="pane-title">右：①グローバル → ②setup() → ③draw()（Cmd/Ctrl+Enterで実行）</div>

      <div class="right-body">
        <!-- グローバル定義 -->
        <div class="globals-pane">
          <div class="editor">
            <header>グローバル変数定義（例：<code>state.count = 0;</code>）</header>
            <div class="cm-host"><textarea id="globals-editor"></textarea></div>
          </div>
        </div>
        <div class="row-resizer-G" id="resizerGlobals" title="ドラッグで高さを調整"></div>

        <!-- setup / draw -->
        <div class="editors">
          <div class="stack" id="stack">
            <div class="top-pane">
              <div class="editor">
                <header>setup() の中身</header>
                <div class="cm-host"><textarea id="setup-editor"></textarea></div>
              </div>
            </div>
            <div class="row-resizer" id="resizerY" title="ドラッグで高さを調整"></div>
            <div class="bottom-pane">
              <div class="editor">
                <header>draw() の中身</header>
                <div class="cm-host"><textarea id="draw-editor"></textarea></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="statusbar" id="status">Cmd/Ctrl+Enter で実行します</div>
      <div class="errors" id="errors"></div>
    </div>
  </div>

  <script>
    /* ====== 設定・初期サンプル ====== */
    const LS = {
      globals:'p5live.globals',
      setup:'p5live.setup',
      draw:'p5live.draw',
      left:'p5live.leftWidth',
      ratioG:'p5live.topRatioGlobals',
      ratioE:'p5live.topRatioEditors'
    };

    const DEFAULT_GLOBALS =
`// ここで定義した値は setup()/draw() の両方で使えます
// 推奨：state へ格納（例） state.count = 0;
state.count = state.count ?? 0;`;

    const DEFAULT_SETUP =
`// キャンバスは自動作成（createCanvas不要）
noStroke();
background(255);
state.count = 0;`;

    const DEFAULT_DRAW =
`background(240);
fill(0, 120, 255, 150);
circle(mouseX, mouseY, 80);
state.count++;
fill(20); textSize(14);
text('count: ' + state.count, 12, 22);`;

    /* ====== CodeMirror 初期化 ====== */
    const cmOpts = { mode:"javascript", lineNumbers:true, lineWrapping:false, autoCloseBrackets:true };
    const cmGlobals = CodeMirror.fromTextArea(document.getElementById('globals-editor'), cmOpts);
    const cmSetup   = CodeMirror.fromTextArea(document.getElementById('setup-editor'),   cmOpts);
    const cmDraw    = CodeMirror.fromTextArea(document.getElementById('draw-editor'),    cmOpts);

    cmGlobals.setValue(localStorage.getItem(LS.globals) ?? DEFAULT_GLOBALS);
    cmSetup.setValue(  localStorage.getItem(LS.setup)   ?? DEFAULT_SETUP );
    cmDraw.setValue(   localStorage.getItem(LS.draw)    ?? DEFAULT_DRAW  );

    const debounce=(fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
    cmGlobals.on('change', debounce(()=>localStorage.setItem(LS.globals, cmGlobals.getValue()), 300));
    cmSetup.on('change',   debounce(()=>localStorage.setItem(LS.setup,   cmSetup.getValue()),   300));
    cmDraw.on('change',    debounce(()=>localStorage.setItem(LS.draw,    cmDraw.getValue()),    300));

    [cmGlobals, cmSetup, cmDraw].forEach(cm =>
      cm.addKeyMap({ 'Cmd-Enter': runSketch, 'Ctrl-Enter': runSketch })
    );

    /* ====== p5 スケッチ実行 ====== */
    let currentP5 = null;

    function runSketch(){
      // 最新文字列を確定
      cmGlobals.save(); cmSetup.save(); cmDraw.save();
      cmGlobals.refresh(); cmSetup.refresh(); cmDraw.refresh();

      const globalsBody = cmGlobals.getValue();
      const setupBody   = cmSetup.getValue();
      const drawBody    = cmDraw.getValue();

      clearErrors();

      // 既存スケッチ破棄
      if (currentP5) { try { currentP5.remove(); } catch(_){} currentP5 = null; }
      document.getElementById('canvas-wrap').innerHTML = '';

      // 共有オブジェクト
      const state = {};

      // 評価関数（p と state を共有）
      const runG = new Function('p','state', `with(p){ with(state){ ${globalsBody} } }`);
      const runS = new Function('p','state', `with(p){ with(state){ ${setupBody}   } }`);
      const runD = new Function('p','state', `with(p){ with(state){ ${drawBody}    } }`);

      const sketch = (p) => {
        const ensureCanvas = () => {
          const w = Math.max(200, document.getElementById('left').clientWidth);
          const h = window.innerHeight;
          if (!p._renderer) p.createCanvas(w, h); else p.resizeCanvas(w, h);
          if (p.canvas && p.canvas.parentElement?.id !== 'canvas-wrap') {
            document.getElementById('canvas-wrap').appendChild(p.canvas);
          }
        };
        const patchCreateCanvas = () => {
          const orig = p.createCanvas.bind(p);
          p.createCanvas = function(w,h,...rest){
            if (p._renderer) { p.resizeCanvas(w,h); return p._renderer; }
            const r = orig(w,h,...rest);
            if (p.canvas && p.canvas.parentElement?.id !== 'canvas-wrap') {
              document.getElementById('canvas-wrap').appendChild(p.canvas);
            }
            return r;
          };
        };

        p.setup = () => {
          try { ensureCanvas(); patchCreateCanvas(); runG(p,state); runS(p,state); }
          catch(e){ reportError('setup', e); p.noLoop(); }
        };
        p.draw  = () => {
          try { runD(p,state); }
          catch(e){ reportError('draw', e); p.noLoop(); }
        };
        p.windowResized = () => {
          try { p.resizeCanvas(Math.max(200, document.getElementById('left').clientWidth), window.innerHeight); }
          catch(e){}
        };
      };

      currentP5 = new p5(sketch, document.getElementById('canvas-wrap'));
      setStatus('実行しました（Cmd/Ctrl+Enter）');
    }

    function setStatus(msg){ document.getElementById('status').textContent = msg; }
    function clearErrors(){ document.getElementById('errors').textContent = ''; }
    function reportError(phase, err){
      document.getElementById('errors').textContent = `⚠️ ${phase} エラー: ${err?.message || err}`;
      setStatus(`${phase} でエラー`);
      console.error(`[${phase}]`, err);
    }

    function hostResizeCanvasToLeftPane(){
      if (!currentP5) return;
      try {
        currentP5.resizeCanvas(Math.max(200, document.getElementById('left').clientWidth), window.innerHeight);
      } catch(e){}
    }
    function refreshEditors(){ cmGlobals.refresh(); cmSetup.refresh(); cmDraw.refresh(); }

    /* ====== 境界ドラッグ（左右・上下） ====== */

    // 左右バー（アプリ左端を原点として計算）
    (function(){
      const bar   = document.getElementById('resizerX');
      const appEl = document.querySelector('.app');
      const RIGHT_MIN = 320;   // 右側最小幅
      const BAR_W     = 6;     // 仕切り実幅
      let dragging = false;

      function setLeftWidth(px){
        document.documentElement.style.setProperty('--leftWidth', px + 'px');
        localStorage.setItem(LS.left, px + 'px');
        hostResizeCanvasToLeftPane();
        refreshEditors();
      }

      bar.addEventListener('mousedown', (e)=>{
        dragging = true;
        document.body.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        e.preventDefault();
      });

      window.addEventListener('mousemove', (e)=>{
        if (!dragging) return;
        const rect = appEl.getBoundingClientRect();
        let x = e.clientX - rect.left;                        // .app 左端を原点に
        const maxLeft = rect.width - RIGHT_MIN - BAR_W;       // 右最小幅+バー幅を確保
        const minLeft = 200;                                  // 左最小幅
        x = Math.max(minLeft, Math.min(x, maxLeft));
        setLeftWidth(x);
      });

      window.addEventListener('mouseup', ()=>{
        if (!dragging) return;
        dragging = false;
        document.body.classList.remove('dragging');
        document.body.style.cursor = 'default';
      });
    })();

    // 右：グローバル vs エディタ群
    (function(){
      const bar=document.getElementById('resizerGlobals'); let drag=false,y0=0,r0=0;
      bar.addEventListener('mousedown',e=>{
        drag=true; y0=e.clientY; document.body.style.cursor='row-resize'; e.preventDefault();
        const body=document.querySelector('.right-body').getBoundingClientRect();
        const topH=document.querySelector('.globals-pane').getBoundingClientRect().height;
        r0=topH/body.height;
      });
      window.addEventListener('mousemove',e=>{
        if(!drag) return;
        const body=document.querySelector('.right-body').getBoundingClientRect();
        let r=r0+(e.clientY-y0)/body.height;
        r=Math.min(Math.max(r,0.12),0.6);
        document.documentElement.style.setProperty('--topRatioGlobals', r.toString());
        localStorage.setItem(LS.ratioG, r.toString());
        refreshEditors();
      });
      window.addEventListener('mouseup',()=>{ if(!drag) return; drag=false; document.body.style.cursor='default'; });
    })();

    // 右下：setup vs draw
    (function(){
      const bar=document.getElementById('resizerY'); let drag=false,y0=0,r0=0;
      bar.addEventListener('mousedown',e=>{
        drag=true; y0=e.clientY; document.body.style.cursor='row-resize'; e.preventDefault();
        const stack=document.getElementById('stack').getBoundingClientRect();
        const topH=document.querySelector('.top-pane').getBoundingClientRect().height;
        r0=topH/stack.height;
      });
      window.addEventListener('mousemove',e=>{
        if(!drag) return;
        const stack=document.getElementById('stack').getBoundingClientRect();
        let r=r0+(e.clientY-y0)/stack.height;
        r=Math.min(Math.max(r,0.15),0.85);
        document.documentElement.style.setProperty('--topRatioEditors', r.toString());
        localStorage.setItem(LS.ratioE, r.toString());
        refreshEditors();
      });
      window.addEventListener('mouseup',()=>{ if(!drag) return; drag=false; document.body.style.cursor='default'; });
    })();

    window.addEventListener('resize', ()=>{ hostResizeCanvasToLeftPane(); refreshEditors(); });

    // 初回実行
    runSketch();
    requestAnimationFrame(refreshEditors);
  </script>
</body>
</html>
